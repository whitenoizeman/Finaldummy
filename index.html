<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>คำนวณชิปดัมมี่ (3 ผู้เล่น)</title>
<link rel="manifest" href="manifest.json">
<style>
body{background:#000;color:#fff;font-family:-apple-system, BlinkMacSystemFont, "SF Pro", Arial, sans-serif;margin:0;padding:20px;}
.card{background:#1c1c1e;border-radius:20px;padding:20px;max-width:420px;margin:18px auto;}
h2{margin:0 0 12px 0;font-size:20px;}
label{display:block;margin-top:8px;margin-bottom:6px;color:#c7c7cc;font-size:13px;}
input{width:100%;padding:12px;border-radius:10px;border:none;margin-bottom:10px;background:#2c2c2e;color:#fff;font-size:18px;}
.controls{display:flex;flex-wrap:wrap;gap:8px;margin-top:6px;}
button{flex:1;padding:12px;border-radius:12px;border:none;color:#fff;font-weight:700;font-size:15px;cursor:pointer;}
.btn-blue{background:#0a84ff;}
.btn-red{background:#ff3b30;}
.btn-green{background:#34c759;}
.btn-yellow{background:#ffcc00;color:#000;}
.result-box{background:#111214;border-radius:12px;padding:12px;margin-top:14px;white-space:pre-line;font-size:16px;color:#fff;}
.keyboard{position:fixed;left:8px;right:8px;bottom:8px;background:#151516;padding:10px;border-radius:14px;display:none;box-shadow:0 10px 30px rgba(0,0,0,0.6);}
.key-row{display:flex;gap:8px;margin-bottom:8px;}
.key{flex:1;padding:14px;border-radius:10px;background:#262628;text-align:center;color:#fff;font-size:20px;user-select:none;}
.key:active{transform:scale(0.98);}
.small{font-size:14px;padding:10px;}
.footer{color:#8e8e93;text-align:center;margin-top:14px;font-size:13px;}
@media (prefers-color-scheme: light){
  body{background:#f5f5f7;color:#111;}
  .card{background:#fff;}
  input{background:#f7f7f8;color:#111;border:1px solid #e6e6ea;}
  .keyboard{background:#fff;}
  .key{background:#f2f2f7;color:#111;}
  .result-box{background:#f0f0f2;color:#111;}
}
</style>
</head>
<body>
<div class="card">
  <h2>คำนวณชิปดัมมี่ (3 ผู้เล่น)</h2>

  <label>ค่าพูล</label>
  <input id="pool" placeholder="ตัวอย่าง 0.05" readonly>

  <label>ผู้เล่น A</label>
  <input id="a" placeholder="-50" readonly>

  <label>ผู้เล่น B</label>
  <input id="b" placeholder="120" readonly>

  <label>ผู้เล่น C</label>
  <input id="c" placeholder="-10" readonly>

  <div class="controls">
    <button class="btn-blue" onclick="calc()">คำนวณ</button>
    <button class="btn-red" onclick="clearAll()">ล้างค่า</button>
    <button class="btn-green" onclick="saveRound()">บันทึกรอบ</button>
    <button class="btn-yellow" onclick="showHistory()">ประวัติ</button>
  </div>

  <div id="result" class="result-box" hidden></div>
</div>

<div id="keyboard" class="keyboard" aria-hidden="true">
  <div class="key-row">
    <div class="key" data-v="1">1</div><div class="key" data-v="2">2</div><div class="key" data-v="3">3</div>
  </div>
  <div class="key-row">
    <div class="key" data-v="4">4</div><div class="key" data-v="5">5</div><div class="key" data-v="6">6</div>
  </div>
  <div class="key-row">
    <div class="key" data-v="7">7</div><div class="key" data-v="8">8</div><div class="key" data-v="9">9</div>
  </div>
  <div class="key-row">
    <div class="key" data-v="-">−</div><div class="key" data-v="0">0</div><div class="key" data-v=".">.</div>
  </div>
  <div class="key-row">
    <div class="key small" id="del">⌫</div>
    <div class="key small" id="ok">OK</div>
  </div>
</div>

<div class="footer">PWA • ทำงานออฟไลน์ • แตะช่องเพื่อพิมพ์</div>

<script>
let currentInput = null;

// open keyboard when tapping inputs
["pool","a","b","c"].forEach(id=>{
  const el=document.getElementById(id);
  el.addEventListener("click", ()=> {
    currentInput = el;
    document.getElementById("keyboard").style.display = "block";
    document.getElementById("keyboard").setAttribute("aria-hidden","false");
  });
});

// keyboard input
document.querySelectorAll(".key[data-v]").forEach(k=>{
  k.addEventListener("click", ()=> {
    if(!currentInput) return;
    const v=k.dataset.v;
    if(v === "-" && currentInput.value.includes("-")) return;
    if(v === "." && currentInput.value.includes(".")) return;
    currentInput.value += v;
  });
});

// delete and ok
document.getElementById("del").addEventListener("click", ()=> {
  if(!currentInput) return;
  currentInput.value = currentInput.value.slice(0,-1);
});
document.getElementById("ok").addEventListener("click", ()=> {
  currentInput = null;
  document.getElementById("keyboard").style.display = "none";
  document.getElementById("keyboard").setAttribute("aria-hidden","true");
});

// helper
function toNumber(v){ const n=parseFloat(String(v).replace(/,/,'')); return isNaN(n)?0:n; }

// calculation per original formula
function calc(){
  const A = toNumber(document.getElementById("a").value);
  const B = toNumber(document.getElementById("b").value);
  const C = toNumber(document.getElementById("c").value);
  const pool = toNumber(document.getElementById("pool").value);

  const chipA = ((A-B)+(A-C))*pool;
  const chipB = ((B-A)+(B-C))*pool;
  const chipC = ((C-A)+(C-B))*pool;

  const arr = [{n:"A",v:chipA},{n:"B",v:chipB},{n:"C",v:chipC}];
  const pos = arr.filter(x=>x.v>0).map(x=>({n:x.n,v:x.v}));
  const neg = arr.filter(x=>x.v<0).map(x=>({n:x.n,v:x.v}));

  pos.sort((a,b)=>b.v-a.v);
  neg.sort((a,b)=>a.v-b.v);

  let payments = "";
  let i=0,j=0;
  while(i<pos.length && j<neg.length){
    const take = Math.min(pos[i].v, -neg[j].v);
    payments += `${neg[j].n} → ${pos[i].n}: ${take.toFixed(2)}\n`;
    pos[i].v -= take;
    neg[j].v += take;
    if(pos[i].v <= 0.0001) i++;
    if(neg[j].v >= -0.0001) j++;
  }

  const resultBox = document.getElementById("result");
  resultBox.hidden = false;
  resultBox.textContent = `A: ${chipA.toFixed(2)}\nB: ${chipB.toFixed(2)}\nC: ${chipC.toFixed(2)}\n\nการชำระเงิน:\n${payments}`;
}

// clear
function clearAll(){
  ["pool","a","b","c"].forEach(id=>document.getElementById(id).value="");
  document.getElementById("result").hidden = true;
}

// history save/load
function saveRound(){
  const resultText = document.getElementById("result").textContent;
  if(!resultText) { alert("ยังไม่มีผลให้บันทึก"); return; }
  const hist = JSON.parse(localStorage.getItem("dummy_hist_3")||"[]");
  hist.push({time:Date.now(), text: resultText});
  localStorage.setItem("dummy_hist_3", JSON.stringify(hist));
  alert("บันทึกรอบแล้ว");
}

function showHistory(){
  const hist = JSON.parse(localStorage.getItem("dummy_hist_3")||"[]");
  if(!hist.length){ alert("ยังไม่มีประวัติ"); return; }
  let out = "";
  hist.slice().reverse().forEach(h=> out += new Date(h.time).toLocaleString()+":\n"+h.text+"\n---\n");
  alert(out);
}

// register service worker
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('service-worker.js').catch(()=>{});
}
</script>
</body>
</html>
